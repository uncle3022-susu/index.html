<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>工程帳本 (修復版)</title>
    <style>
        /* --- 1. 核心變數 (抹茶綠主題) --- */
        :root {
            --primary: #5B9A8B; 
            --primary-grad: linear-gradient(135deg, #66BB6A, #43A047);
            --bg-body: #F4F7F6; 
            --bg-card: #FFFFFF;
            --text-main: #2C3E50; 
            --text-sub: #95A5A6;
            --border: #ECF0F1;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius-box: 18px;
            --radius-btn: 14px;
        }

        [data-mode="dark"] {
            --bg-body: #121212; --bg-card: #1E1E1E; --text-main: #E0E0E0; --text-sub: #A0A0A0; --border: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; background: var(--bg-body); color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            overflow-x: hidden;
        }

        /* 頂部標題列 */
        .header-bar {
            position: sticky; top: 0; z-index: 50;
            background: rgba(244, 247, 246, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 12px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        /* 滾輪觸發按鈕 */
        .date-trigger-btn {
            font-size: 1.4rem; font-weight: 700; color: var(--text-main);
            background: transparent; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 6px; padding: 5px 0;
        }
        .date-trigger-btn span { pointer-events: none; }
        .date-trigger-btn::after { content: "▼"; font-size: 0.7rem; opacity: 0.5; margin-left: 5px; }

        /* 通用卡片 */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--bg-card); border-radius: var(--radius-box); padding: 15px; margin-bottom: 15px; 
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }

        /* 日曆網格 */
        .grid-7 { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .week-header { font-size: 0.8rem; color: var(--text-sub); padding-bottom: 8px; margin-bottom: 8px; border-bottom: 1px solid var(--border); }
        .day-cell {
            height: 55px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            border-radius: 10px; padding: 4px; cursor: pointer; position: relative;
        }
        .day-num { font-size: 1rem; font-weight: 500; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; z-index: 2; }
        .day-cell.today .day-num { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .day-dot { width: 5px; height: 5px; border-radius: 50%; margin-top: 4px; background: transparent; }
        .has-work .day-dot { background: var(--primary); }

        /* 按鈕與輸入框 */
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: var(--radius-btn); 
            font-weight: 700; font-size: 16px; cursor: pointer; color: white; 
            background: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            transition: transform 0.1s; margin-top: 10px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-danger { background: #FF6B6B; }
        .input-f { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 12px; font-size: 16px; background: var(--bg-body); color: var(--text-main); outline: none; margin-bottom: 10px; }

        /* 底部導航 */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: calc(70px + env(safe-area-inset-bottom));
            background: var(--bg-card); border-top: 1px solid var(--border); 
            display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); 
            z-index: 90;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* 滾輪選擇器與 Modal */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2000; display: none; opacity: 0; transition: opacity 0.2s;
            align-items: flex-end; justify-content: center;
        }
        .modal-box {
            width: 100%; background: var(--bg-card); border-radius: 20px 20px 0 0; padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            max-height: 80vh; overflow-y: auto;
        }
        
        /* 滾輪樣式 */
        .picker-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .picker-body { display: flex; height: 180px; position: relative; overflow: hidden; mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 20%, black 80%, transparent); }
        .wheel { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; text-align: center; padding: 70px 0; }
        .wheel::-webkit-scrollbar { display: none; }
        .wheel-item { height: 40px; line-height: 40px; font-size: 1.1rem; scroll-snap-align: center; color: var(--text-sub); opacity: 0.4; }
        .wheel-item.selected { color: var(--text-main); font-size: 1.3rem; font-weight: bold; opacity: 1; }
        .wheel-highlight { position: absolute; top: 50%; left: 0; width: 100%; height: 40px; margin-top: -20px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); pointer-events: none; }

        /* 主題球 */
        .theme-row { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .theme-dot { width: 45px; height: 45px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .theme-dot.active { border-color: var(--text-main); transform: scale(1.1); }
    </style>
</head>
<body>

    <header class="header-bar">
        <button class="date-trigger-btn" onclick="openDatePicker()">
            <span id="dispYear">2026</span>年 <span id="dispMonth">1</span>月
        </button>
        <div onclick="switchPage('set')" style="font-size:1.2rem; opacity:0.6;">⚙️</div>
    </header>

    <main>
        <section id="pg-cal" class="page active">
            <div class="card">
                <div class="grid-7 week-header">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div id="calGrid" class="grid-7"></div>
            </div>
            <div id="dayDetail" style="display:none; margin-top:10px;">
                <h3 id="selDateTxt" style="margin:0 0 10px 0;"></h3>
                <div id="siteList"></div>
                <button class="btn" onclick="openSiteEdit()">+ 新增案場</button>
            </div>
        </section>

        <section id="pg-work" class="page">
            <div class="card" style="background: var(--text-main); color: white;">
                <div style="opacity:0.8; font-size:0.9rem">本月預估支出</div>
                <div id="totalExp" style="font-size:2.2rem; font-weight:800; margin:5px 0">$0</div>
            </div>
            <input type="text" class="input
