<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>å·¥ç¨‹å¸³æœ¬ Pro (æ»¾è¼ªç‰ˆ)</title>
    <style>
        /* --- 1. CSS è®Šæ•¸ç³»çµ± (ä¸»é¡Œæ ¸å¿ƒ) --- */
        :root {
            /* é è¨­å€¼ (æœƒè¢« JS è¦†è“‹) */
            --primary: #5B9A8B; /* æŠ¹èŒ¶ç¶  */
            --primary-light: #E8F5E9;
            --primary-grad: linear-gradient(135deg, #66BB6A, #43A047);
            --bg-body: #F4F7F6; 
            --bg-card: #FFFFFF;
            --text-main: #2C3E50; 
            --text-sub: #95A5A6;
            --border: #ECF0F1;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius-box: 20px;
            --radius-btn: 16px;
        }

        [data-mode="dark"] {
            --bg-body: #121212; --bg-card: #1E1E1E; --text-main: #E0E0E0; --text-sub: #A0A0A0; --border: #333;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; background: var(--bg-body); color: var(--text-main);
            font-family: -apple-system, "SF Pro Text", BlinkMacSystemFont, sans-serif;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            overflow-x: hidden; transition: background 0.3s ease;
        }

        /* --- 2. é ‚éƒ¨å°èˆª & æ—¥æœŸæ»¾è¼ªè§¸ç™¼å€ --- */
        .header-bar {
            position: sticky; top: 0; z-index: 50;
            background: var(--bg-body); /* èˆ‡èƒŒæ™¯èåˆï¼Œæ›´æœ‰ App æ„Ÿ */
            padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        
        /* æ¨¡ä»¿åœ–å››çš„æ—¥æœŸé¡¯ç¤ºæ–¹å¼ */
        .date-trigger-btn {
            font-size: 1.5rem; font-weight: 700; color: var(--text-main);
            background: transparent; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 8px; padding: 0;
        }
        .date-trigger-btn::after {
            content: "â–¼"; font-size: 0.8rem; color: var(--text-sub); opacity: 0.6;
        }

        .icon-btn {
            background: var(--bg-card); border: 1px solid var(--border);
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--text-main);
        }

        /* --- 3. å¡ç‰‡èˆ‡å…§å®¹ --- */
        .page { display: none; padding: 10px 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--bg-card); border-radius: var(--radius-box); padding: 20px; margin-bottom: 20px; 
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }

        /* æ—¥æ›†æ¨£å¼ (é…åˆåœ–ä¸‰) */
        .grid-7 { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; }
        .week-header { font-size: 0.85rem; color: var(--text-sub); padding-bottom: 10px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .day-grid { gap: 8px 4px; }
        
        .day-cell {
            min-height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            border-radius: 10px; padding: 4px; cursor: pointer; position: relative;
        }
        .day-num { font-size: 1rem; font-weight: 500; z-index: 2; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .day-cell.today .day-num { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .day-dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 4px; background: transparent; }
        .has-work .day-dot { background: var(--primary); }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stat-banner {
            background: var(--text-main); color: white; /* æ·±è‰²èƒŒæ™¯ */
            border-radius: var(--radius-box); padding: 25px; margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        /* æŒ‰éˆ•ç¾åŒ– (è§£æ±º"å¾ˆé†œçš„è—è‰²") */
        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: var(--radius-btn); 
            font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 10px; color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary-grad); } /* ä½¿ç”¨ä¸»é¡Œæ¼¸å±¤ */
        .btn-danger { background: linear-gradient(135deg, #FF6B6B, #EE5253); }

        /* è¼¸å…¥æ¡† */
        .input-group { background: var(--bg-card); padding: 10px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 10px; display: flex; align-items: center; }
        .input-f { border: none; width: 100%; font-size: 16px; outline: none; background: transparent; color: var(--text-main); margin-left: 10px; }

        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; height: calc(75px + env(safe-area-inset-bottom));
            background: var(--bg-card); border-top: 1px solid var(--border); 
            display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); 
            z-index: 90; backdrop-filter: blur(10px);
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-sub); font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* --- 4. æ»¾è¼ªæ—¥æœŸé¸æ“‡å™¨ (Custom Wheel Picker) --- */
        .picker-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2000; display: none; opacity: 0;
            transition: opacity 0.3s;
        }
        .picker-box {
            position: absolute; bottom: 0; width: 100%; background: var(--bg-card);
            border-radius: 24px 24px 0 0; padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .picker-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: var(--primary); }
        .picker-body { display: flex; height: 200px; position: relative; overflow: hidden; mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent); -webkit-mask-image: linear-gradient(to bottom, transparent, black 40%, black 60%, transparent); }
        .wheel-col { flex: 1; height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; text-align: center; padding: 80px 0; }
        .wheel-col::-webkit-scrollbar { display: none; } /* éš±è—æ²è»¸ */
        .wheel-item { height: 40px; line-height: 40px; font-size: 1.2rem; scroll-snap-align: center; color: var(--text-sub); opacity: 0.5; transition: all 0.2s; }
        .wheel-item.selected { color: var(--text-main); font-size: 1.4rem; font-weight: bold; opacity: 1; transform: scale(1.1); }
        .selection-highlight {
            position: absolute; top: 50%; left: 0; width: 100%; height: 40px; margin-top: -20px;
            border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); pointer-events: none;
        }

        /* ä¸»é¡Œé¸æ“‡å™¨ */
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .theme-opt { aspect-ratio: 1; border-radius: 50%; border: 3px solid transparent; cursor: pointer; position: relative; }
        .theme-opt.active { border-color: var(--text-main); transform: scale(1.1); }

    </style>
</head>
<body>

<header class="header-bar">
    <button class="date-trigger-btn" onclick="openDatePicker()">
        <span id="displayYear">2026</span>å¹´ <span id="displayMonth">1</span>æœˆ
    </button>
    <div class="icon-btn" onclick="switchPage('set', document.getElementById('nav-set'))">âš™ï¸</div>
</header>

<main style="padding-bottom: 20px;">
    <section id="tab-cal" class="page active">
        <div class="card">
            <div class="grid-7 week-header">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div id="calendarGrid" class="grid-7 day-grid"></div>
        </div>
        <div id="daySummary" style="margin-top:20px; display:none;">
            <h3 id="selDateTitle" style="margin:0 0 10px 0;"></h3>
            <div id="daySiteList"></div>
            <button class="btn btn-primary" onclick="openSiteEdit(null)">+ æ–°å¢æ¡ˆå ´</button>
        </div>
    </section>

    <section id="tab-work" class="page">
        <div class="stat-banner">
            <div style="opacity:0.8; font-size:0.9rem">æœ¬æœˆé ä¼°æ”¯å‡º</div>
            <div style="font-size:2.5rem; font-weight:800; margin:5px 0" id="totalExp">$0</div>
        </div>
        
        <div class="input-group">
            <span>ğŸ”</span>
            <input type="text" id="workerSearch" class="input-f" placeholder="æœå°‹å¸«å‚…..." oninput="renderWorkerList()">
        </div>
        
        <button class="btn btn-primary" onclick="openWorkerModal(null)">+ æ–°å¢å¸«å‚…</button>
        
        <div id="workerList" style="margin-top: 20px;"></div>
    </section>

    <section id="tab-set" class="page">
        <div class="card">
            <h3>ğŸ¨ ä¸»é¡Œé¢¨æ ¼</h3>
            <p style="color:var(--text-sub); font-size:0.9rem">é¸æ“‡ä½ å–œæ­¡çš„é…è‰²</p>
            <div class="theme-grid" id="themeContainer"></div>
        </div>
        <div class="card">
            <h3>ğŸ“‚ è³‡æ–™ç®¡ç†</h3>
            <button class="btn btn-danger" onclick="masterReset()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
        </div>
    </section>
</main>

<nav class="bottom-nav">
    <div id="nav-cal" class="nav-item active" onclick="switchPage('cal', this)">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>æ—¥æ›†</span>
    </div>
    <div id="nav-work" class="nav-item" onclick="switchPage('work', this)">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path></svg><span>äººå“¡</span>
    </div>
    <div id="nav-set" class="nav-item" onclick="switchPage('set', this)">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span>è¨­å®š</span>
    </div>
</nav>

<div id="datePicker" class="picker-overlay" onclick="closeDatePicker()">
    <div class="picker-box" onclick="event.stopPropagation()">
        <div class="picker-header">
            <span onclick="closeDatePicker()" style="color:var(--text-sub); font-weight:400; cursor:pointer">å–æ¶ˆ</span>
            <span>é¸æ“‡æœˆä»½</span>
            <span onclick="confirmDate()" style="cursor:pointer">ç¢ºå®š</span>
        </div>
        <div class="picker-body">
            <div class="selection-highlight"></div>
            <div class="wheel-col" id="yearWheel"></div> <div class="wheel-col" id="monthWheel"></div> </div>
    </div>
</div>

<div id="modalOverlay" class="picker-overlay" onclick="closeModal()">
    <div class="picker-box" onclick="event.stopPropagation()">
        <div id="modalContent"></div>
    </div>
</div>

<script>
/* --- 1. è³‡æ–™åº«èˆ‡å…¨åŸŸè®Šæ•¸ --- */
let db = { workers: [], sites: [], theme: 'matcha' }; // é è¨­æ”¹ç‚ºæŠ¹èŒ¶
let curDate = new Date();
let selDateStr = "";

// ä¸»é¡Œå®šç¾© (è‰²ç¥¨ç³»çµ±)
const THEMES = {
    'matcha': { main: '#5B9A8B', grad: 'linear-gradient(135deg, #8FC1A9, #5B9A8B)', bg: '#F4F7F6' }, // æŠ¹èŒ¶ç¶  (ä½ å–œæ­¡çš„)
    'ocean':  { main: '#2980B9', grad: 'linear-gradient(135deg, #3498DB, #2980B9)', bg: '#ECF5FA' }, // æµ·æ´‹è—
    'sunset': { main: '#E67E22', grad: 'linear-gradient(135deg, #F39C12, #D35400)', bg: '#FEF5E7' }, // å¤•é™½æ©˜
    'purple': { main: '#8E44AD', grad: 'linear-gradient(135deg, #9B59B6, #8E44AD)', bg: '#F5EEF8' }, // è–°è¡£è‰
    'dark':   { main: '#555',    grad: 'linear-gradient(135deg, #555, #333)',       bg: '#121212', mode: 'dark' } // æ¥µç°¡é»‘
};

/* --- 2. åˆå§‹åŒ– --- */
window.onload = function() {
    loadData();
    applyTheme(db.theme);
    renderThemeOpts();
    curDate.setDate(1); // è¨­ç‚ºç•¶æœˆ1è™Ÿ
    updateDateDisplay();
    renderAll();
};

function loadData() {
    const d = localStorage.getItem('PRO_LEDGER_DB');
    if(d) db = JSON.parse(d);
    if(!db.theme) db.theme = 'matcha';
}
function saveData() {
    localStorage.setItem('PRO_LEDGER_DB', JSON.stringify(db));
}

/* --- 3. æ ¸å¿ƒåŠŸèƒ½ --- */
function updateDateDisplay() {
    document.getElementById('displayYear').innerText = curDate.getFullYear();
    document.getElementById('displayMonth').innerText = curDate.getMonth() + 1;
}

function renderAll() {
    renderCalendar();
    renderWorkerList();
}

// æ¸²æŸ“æ—¥æ›†
function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    const y = curDate.getFullYear(), m = curDate.getMonth();
    grid.innerHTML = "";
    
    // ç©ºæ ¼å¡«è£œ
    const firstDay = new Date(y, m, 1).getDay();
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

    const daysInM = new Date(y, m+1, 0).getDate();
    const today = new Date();

    for(let d=1; d<=daysInM; d++) {
        const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hasWork = db.sites.some(s => s.date === dStr);
        const isToday = (today.getFullYear()===y && today.getMonth()===m && today.getDate()===d);
        
        grid.innerHTML += `
            <div class="day-cell ${isToday?'today':''} ${hasWork?'has-work':''}" onclick="selectDay('${dStr}')">
                <div class="day-num">${d}</div>
                <div class="day-dot"></div>
            </div>`;
    }
}

// é»æ“Šæ—¥æœŸé¡¯ç¤ºè©³æƒ…
function selectDay(dStr) {
    selDateStr = dStr;
    const box = document.getElementById('daySummary');
    const list = document.getElementById('daySiteList');
    document.getElementById('selDateTitle').innerText = `ğŸ“… ${dStr}`;
    box.style.display = 'block';
    
    // æ¸²æŸ“è©²æ—¥æ¡ˆå ´
    const sites = db.sites.filter(s => s.date === dStr);
    if(sites.length === 0) {
        list.innerHTML = `<p style="color:#999; text-align:center;">æœ¬æ—¥ç„¡ç´€éŒ„</p>`;
    } else {
        list.innerHTML = "";
        sites.forEach(s => {
            list.innerHTML += `
                <div class="card" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${s.name}</b> <span style="font-size:0.8rem; color:#888">${s.workerIds.length}äºº</span></div>
                    <button class="btn btn-danger" style="width:auto; margin:0; padding:8px 15px; font-size:12px;" onclick="delSite('${s.id}')">åˆªé™¤</button>
                </div>`;
        });
    }
    // æ»¾å‹•åˆ°ä¸‹æ–¹
    box.scrollIntoView({behavior: 'smooth'});
}

/* --- 4. æ»¾è¼ªæ—¥æœŸé¸æ“‡å™¨é‚è¼¯ (ä»¿ iOS) --- */
let tempY, tempM; // æš«å­˜é¸æ“‡

function openDatePicker() {
    const el = document.getElementById('datePicker');
    const box = el.querySelector('.picker-box');
    el.style.display = 'block';
    setTimeout(() => { el.style.opacity = 1; box.style.transform = 'translateY(0)'; }, 10);
    
    // åˆå§‹åŒ–æ»¾è¼ª
    initWheel('yearWheel', 2020, 2035, curDate.getFullYear());
    initWheel('monthWheel', 1, 12, curDate.getMonth() + 1);
}

function initWheel(id, min, max, curVal) {
    const con = document.getElementById(id);
    con.innerHTML = "";
    // å‰å¾ŒåŠ ç©ºç™½è®“ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹èƒ½ç½®ä¸­
    con.innerHTML += `<div style="height:80px;"></div>`;
    for(let i=min; i<=max; i++) {
        const item = document.createElement('div');
        item.className = `wheel-item ${i === curVal ? 'selected' : ''}`;
        item.innerText = i + (id==='monthWheel'?'æœˆ':'å¹´');
        item.dataset.val = i;
        con.appendChild(item);
    }
    con.innerHTML += `<div style="height:80px;"></div>`;
    
    // æ»¾å‹•åˆ°ç›®å‰ä½ç½®
    const target = con.querySelector('.selected');
    if(target) {
        // ç­‰å¾…æ¸²æŸ“å¾Œæ»¾å‹•
        setTimeout(() => {
             con.scrollTo({ top: target.offsetTop - 80, behavior: 'auto' });
        }, 0);
    }

    // ç›£è½æ»¾å‹•äº‹ä»¶ (Highlightæ•ˆæœ)
    con.onscroll = function() {
        let center = con.scrollTop + 100; // è¦–çª—ä¸­å¿ƒé»ç´„ç•¥ä½ç½®
        let items = con.querySelectorAll('.wheel-item');
        items.forEach(it => {
            let top = it.offsetTop;
            if (top > center - 30 && top < center + 30) {
                items.forEach(x=>x.classList.remove('selected'));
                it.classList.add('selected');
                if(id === 'yearWheel') tempY = parseInt(it.dataset.val);
                if(id === 'monthWheel') tempM = parseInt(it.dataset.val);
            }
        });
    };
}

function closeDatePicker() {
    const el = document.getElementById('datePicker');
    const box = el.querySelector('.picker-box');
    el.style.opacity = 0; box.style.transform = 'translateY(100%)';
    setTimeout(() => el.style.display = 'none', 300);
}

function confirmDate() {
    // å–å¾—ç•¶å‰é¸ä¸­çš„å€¼
    const yEl = document.querySelector('#yearWheel .selected');
    const mEl = document.querySelector('#monthWheel .selected');
    if(yEl) curDate.setFullYear(parseInt(yEl.dataset.val));
    if(mEl) curDate.setMonth(parseInt(mEl.dataset.val) - 1);
    
    updateDateDisplay();
    renderAll();
    closeDatePicker();
}

/* --- 5. ä¸»é¡Œåˆ‡æ›é‚è¼¯ --- */
function renderThemeOpts() {
    const c = document.getElementById('themeContainer');
    c.innerHTML = "";
    for(let k in THEMES) {
        c.innerHTML += `<div class="theme-opt ${db.theme===k?'active':''}" 
        style="background:${THEMES[k].grad}" onclick="applyTheme('${k}')"></div>`;
    }
}

function applyTheme(key) {
    db.theme = key;
    const t = THEMES[key];
    const r = document.documentElement;
    r.style.setProperty('--primary', t.main);
    r.style.setProperty('--primary-grad', t.grad);
    r.style.setProperty('--bg-body', t.bg);
    
    if(t.mode === 'dark') r.setAttribute('data-mode', 'dark');
    else r.removeAttribute('data-mode');
    
    renderThemeOpts();
    saveData();
}

/* --- 6. å…¶ä»–æ¥­å‹™é‚è¼¯ (ç°¡åŒ–ç‰ˆ) --- */
function openWorkerModal(id) {
    let h = `<h3>${id?'ç·¨è¼¯':'æ–°å¢'}å¸«å‚…</h3>
    <input id="wName" class="input-f" style="border:1px solid #ddd; padding:10px; border-radius:10px; width:100%" placeholder="å§“å">
    <input id="wRate" type="number" class="input-f" style="border:1px solid #ddd; padding:10px; border-radius:10px; width:100%; margin-top:10px" placeholder="æ—¥è–ª">
    <button class="btn btn-primary" onclick="saveWorker('${id||''}')">å„²å­˜</button>`;
    
    document.getElementById('modalContent').innerHTML = h;
    document.getElementById('modalOverlay').style.display = 'block';
    setTimeout(()=>document.getElementById('modalOverlay').style.opacity=1,10);
    document.querySelector('#modalOverlay .picker-box').style.transform = 'translateY(0)';
}

function saveWorker(id) {
    const name = document.getElementById('wName').value;
    const rate = document.getElementById('wRate').value;
    if(!name) return;
    if(id) {
        // Update
    } else {
        db.workers.push({ id: 'w'+Date.now(), name, rate });
    }
    saveData();
    closeModal();
    renderWorkerList();
}

function renderWorkerList() {
    const list = document.getElementById('workerList');
    list.innerHTML = "";
    db.workers.forEach(w => {
        list.innerHTML += `<div class="card" style="padding:15px; display:flex; justify-content:space-between">
            <b>${w.name}</b><span>$${w.rate}/æ—¥</span>
        </div>`;
    });
}

function openSiteEdit(id) {
    if(!selDateStr) return alert("è«‹å…ˆé»é¸æ—¥æœŸ");
    let h = `<h3>æ–°å¢æ¡ˆå ´ (${selDateStr})</h3>
    <input id="sName" class="input-f" style="border:1px solid #ddd; padding:10px; border-radius:10px; width:100%" placeholder="æ¡ˆå ´åç¨±">
    <div style="margin:10px 0; max-height:150px; overflow:auto;">`;
    
    db.workers.forEach(w => {
        h += `<div style="padding:8px; border-bottom:1px solid #eee"><label><input type="checkbox" class="wk-chk" value="${w.id}"> ${w.name}</label></div>`;
    });
    
    h += `</div><button class="btn btn-primary" onclick="saveSite()">å„²å­˜</button>`;
    
    document.getElementById('modalContent').innerHTML = h;
    document.getElementById('modalOverlay').style.display = 'block';
    setTimeout(()=>document.getElementById('modalOverlay').style.opacity=1,10);
    document.querySelector('#modalOverlay .picker-box').style.transform = 'translateY(0)';
}

function saveSite() {
    const name = document.getElementById('sName').value;
    const chks = document.querySelectorAll('.wk-chk:checked');
    const wIds = Array.from(chks).map(c => c.value);
    
    if(!name) return alert("è«‹è¼¸å…¥åç¨±");
    
    db.sites.push({ id: 's'+Date.now(), date: selDateStr, name, workerIds: wIds });
    saveData();
    closeModal();
    renderAll();
    selectDay(selDateStr); // é‡æ–°è¼‰å…¥è©³æƒ…
}

function delSite(id) {
    if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
    db.sites = db.sites.filter(s => s.id !== id);
    saveData();
    renderAll();
    selectDay(selDateStr);
}

function closeModal() {
    const el = document.getElementById('modalOverlay');
    const box = el.querySelector('.picker-box');
    box.style.transform = 'translateY(100%)';
    el.style.opacity = 0;
    setTimeout(()=>el.style.display='none', 300);
}

function switchPage(p, btn) {
    document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
    document.getElementById('tab-'+p).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
    if(btn) btn.classList.add('active');
}

function masterReset() {
    if(confirm("ç¢ºå®šæ¸…ç©º?")) { localStorage.removeItem('PRO_LEDGER_DB'); location.reload(); }
}
</script>
</body>
</html>
